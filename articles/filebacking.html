<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Analyze high-dimensional PLINK data with filebacking • plmmr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Analyze high-dimensional PLINK data with filebacking">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">plmmr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">3.1.1.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting-started.html">Getting started</a></li>
    <li><a class="dropdown-item" href="../articles/process_plink_files.html">If your data is from PLINK...</a></li>
    <li><a class="dropdown-item" href="../articles/notation.html">Notes on notation</a></li>
    <li><a class="dropdown-item" href="../articles/filebacking.html">File-backed data (how to work with big files)</a></li>
    <li><a class="dropdown-item" href="../articles/deconfounding.html">In progress: PLMMs &amp; deconfounding</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pbreheny/plmmr"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Analyze high-dimensional PLINK data with filebacking</h1>
            
      

      <div class="d-none name"><code>filebacking.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">plmmr</span><span class="op">)</span></span>
<span><span class="co"># MUST have biglasso version &gt;= 1.5.2.1 - uncomment &amp; run line below if needed</span></span>
<span><span class="co"># remotes::install_github(repo = "YaohuiZeng/biglasso") </span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pbreheny.github.io/biglasso/index.html" class="external-link">biglasso</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://privefl.github.io/bigsnpr/" class="external-link">bigsnpr</a></span><span class="op">)</span></span></code></pre></div>
<p><strong>Preliminary note</strong>: rendering this vignette is proving
to be tricky, given that these examples read in external data files.
Right now, this renders on my local machine – I am still working out the
kinks of getting this to render for our website. For now, I’ve left
<code>eval=FALSE</code> just so you all can at least see the code. Let
me know if you have any questions. –Tabitha</p>
<p>In many applications of high dimensional data analysis, the dataset
is too large to read into R – the session will crash for lack of memory.
This is almost always an issue with analyzing genetic data from <a href="https://www.cog-genomics.org/plink/" class="external-link">PLINK</a> files. To analyze
such large datasets, <code>plmmr</code> is equipped to analyze data
using <em>filebacking</em> - a strategy that lets R ‘point’ to a file on
disk, rather than reading the file into the R session. Many other
packages use this technique - <a href="https://privefl.github.io/bigstatsr/" class="external-link">bigstatsr</a> and <a href="https://github.com/pbreheny/biglasso" class="external-link">biglasso</a> are two
examples of packages that use filebacking. The novelties of
<code>plmmr</code> are:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Integration</strong>: <code>plmmr</code> combines the
functionality of several packages in order to do quality control, model
fitting/analysis, and data visualization all in one package.
<code>plmmr</code> will take you from PLINK files all the way to a list
of SNPs for downstream analysis.</p></li>
<li><p><strong>Accessibility</strong>: <code>plmmr</code> can be run
from an <code>R</code> session on a typical desktop/laptop machine. The
user does not need access to a supercomputer or experience with the
command line in order to fit models <code>plmmr</code>. If you don’t
know what the ‘command line’ means, don’t worry - <code>plmmr</code> was
designed with you in mind :)</p></li>
<li><p><strong>Handling correlation</strong>: <code>plmmr</code> uses a
transformation that addresses correlation among samples and uses this
correlation to improve predictions (via the best linear unbiased
predictor, or BLUP). This means that in <code><a href="../reference/plmm.html">plmm()</a></code>, there’s no
need to filter data down to a ‘maximum subset of unrelated
individuals.’</p></li>
</ol>
<p>The tutorial that follows will walk you through each step of the
process. We will use the <code>penncath_lite</code> data that ships with
our <code>plmmr</code> package – if you’ve installed this package, you
have this dataset as a set of PLINK files. These PLINK files represent
about 1400 participants and 4,000+ SNPs. This dataset is small enough
that we could read it into memory (4,000 is a small number of SNPs to
study), but I will analyze it using filebacked methods here for the sake
of example. The steps shown here would be the same for GWAS-sized
datasets (100,000 - 800,000 SNPs). More information about the
<code>penncath_lite</code> data is given in the <code>PLINK files</code>
article. <strong>Note</strong>: if you haven’t done so already, go ahead
and <span style="color:purple">unzip the PLINK files that came with
<code>plmmr</code></span></p>
<p>If you are on MacOS or Linux, you can run this command to unzip:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># using a temp dir -- change to fit your preference</span></span>
<span><span class="fu"><a href="../reference/unzip_example_data.html">unzip_example_data</a></span><span class="op">(</span>outdir <span class="op">=</span> <span class="va">temp_dir</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="analyzing-filebacked-data-from-start-to-finish">Analyzing filebacked data from start to finish<a class="anchor" aria-label="anchor" href="#analyzing-filebacked-data-from-start-to-finish"></a>
</h2>
<div class="section level3">
<h3 id="step-1-preprocess-the-data">Step 1: preprocess the data<a class="anchor" aria-label="anchor" href="#step-1-preprocess-the-data"></a>
</h3>
<p>The most important step is where you begin – for GWAS data, we have
to tell <code>plmmr</code> how to combine information across all three
PLINK files (the <code>.bed</code>, <code>.bim</code>, and
<code>.fam</code> files).</p>
<p>Here, we will create the files we want in a temporary directory just
for the sake of example. Users can specify the folder of their choice
for <code>rds_dir</code>, as shown below:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># using a temporary directory (if you didn't already create one above)</span></span>
<span></span>
<span><span class="va">plink_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/process_plink.html">process_plink</a></span><span class="op">(</span>data_dir <span class="op">=</span> <span class="fu"><a href="../reference/find_example_data.html">find_example_data</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                            <span class="co"># ^ reads data from inst/extdata; change this to match where your data files are</span></span>
<span>              rds_dir <span class="op">=</span> <span class="va">temp_dir</span>,</span>
<span>              prefix <span class="op">=</span> <span class="st">"penncath_lite"</span>,</span>
<span>              overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>              impute_method <span class="op">=</span> <span class="st">"mode"</span><span class="op">)</span></span></code></pre></div>
<p>You’ll see a lot of messages printed to the console here … the result
of all this is the creation of 3 files:
<code>std_penncath_lite.rds</code> and <code>std_penncath_lite.bk</code>
contain the data, and <code>process_plink.log</code> is a text file
documenting the steps that were just done. These will show up in the
folder where the PLINK data is; the file path to the .rds object is
returned here to <code>plink_data</code></p>
<p>We can examine what’s in <code>std_penncath_lite.rds</code> using the
<code><a href="https://privefl.github.io/bigsnpr/reference/snp_attach.html" class="external-link">snp_attach()</a></code> function from the <code>bigsnpr</code>
package:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">plink_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">pen</span><span class="op">)</span> <span class="co"># note: genotypes and std_X are *not* in memory</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># we can check to see that our data have been standardized </span></span>
<span><span class="va">std_X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/bigmemory/man/attach.big.matrix.html" class="external-link">attach.big.matrix</a></span><span class="op">(</span><span class="va">pen</span><span class="op">$</span><span class="va">std_X</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">std_X</span><span class="op">[</span>,<span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># columns have mean zero...</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">std_X</span><span class="op">[</span>,<span class="op">]</span>, <span class="fl">2</span>, <span class="va">var</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># ... &amp; variance 1</span></span></code></pre></div>
<div class="section level4">
<h4 id="what-if-my-data-arent-in-plink-format">What if my data aren’t in PLINK format?<a class="anchor" aria-label="anchor" href="#what-if-my-data-arent-in-plink-format"></a>
</h4>
<p>The methodology in <code>plmmr</code> was motivated by applications
in GWAS, but it certainly isn’t limited to that context. Suppose you
have a high dimensional data set, such as the <code>colon2</code> data –
this is like the <code>colon</code> data that ships with the
<code>biglasso</code> package, only here I’ve inserted some NA values
just for didactic purposes.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">colon_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/process_delim.html">process_delim</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"colon2.txt"</span>,</span>
<span>          data_dir <span class="op">=</span> <span class="fu"><a href="../reference/find_example_data.html">find_example_data</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>          rds_dir <span class="op">=</span> <span class="va">temp_dir</span>,</span>
<span>          ind.col <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">2002</span><span class="op">)</span> <span class="co"># don't use the 1st column; it has IDs in it</span></span>
<span></span>
<span><span class="va">std_colon2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">colon_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">std_colon2</span><span class="op">)</span> <span class="co"># notice that the columns with NA values were dropped </span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="step-2-fit-a-model">Step 2: fit a model<a class="anchor" aria-label="anchor" href="#step-2-fit-a-model"></a>
</h3>
<p>Note: for data coming from <code><a href="../reference/process_plink.html">process_plink()</a></code>, the
<code>y</code> argument in <code><a href="../reference/plmm.html">plmm()</a></code> defaults to using the 6th
column from the ‘.fam’ file as the phenotype/outcome (this behavior is
the same as what PLINK does).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fb_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plmm.html">plmm</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">plink_data</span>,</span>
<span>               returnX <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>               <span class="co"># this datset is small enough to fit in memory</span></span>
<span>               <span class="co"># by setting returnX = FALSE, I force plmm() to run on the filebacked data</span></span>
<span>               save_rds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">temp_dir</span>, <span class="st">"fb_fit"</span><span class="op">)</span>,</span>
<span>               <span class="co"># save results to my temp directory, and name files 'fb_fit'</span></span>
<span>               trace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We can confirm that our filebacked methods and in-memory methods give
the same results:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plmm.html">plmm</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">plink_data</span>, <span class="co"># will run in-memory by default, since data will fit</span></span>
<span>            trace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b1</span> <span class="op">&lt;-</span> <span class="va">fb_fit</span><span class="op">$</span><span class="va">beta_vals</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">b2</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">beta_vals</span></span>
<span><span class="fu">tinytest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tinytest/man/expect_equal.html" class="external-link">expect_equivalent</a></span><span class="op">(</span><span class="va">b1</span>, <span class="va">b2</span>, <span class="fl">0.01</span><span class="op">)</span> </span></code></pre></div>
<p>The format is similar for data that came from
<code>process_delim</code> – however, in the case of our
<code>colon2</code> data, we need to supply our own kinship matrix. The
data are not genomic, so estimating a genomic relatedness matrix doesn’t
make sense. For our purposes, we will make up a ‘dummy’ K matrix.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># pretend genomic data from 500 SNPs</span></span>
<span><span class="va">genomic_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">62</span><span class="op">*</span><span class="fl">500</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">62</span>, ncol <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/relatedness_mat.html">relatedness_mat</a></span><span class="op">(</span><span class="va">genomic_dat</span><span class="op">)</span></span>
<span><span class="va">pretend_outcome</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">62</span><span class="op">)</span> <span class="co"># notice: this is a completely made-up outcome</span></span>
<span><span class="co"># depending on the seed used for this rnorm() call, results may look aberrant/'weird'</span></span>
<span><span class="va">colon2_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plmm.html">plmm</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">temp_dir</span>, <span class="st">"std_colon2"</span><span class="op">)</span>,</span>
<span>                   y <span class="op">=</span> <span class="va">pretend_outcome</span>,</span>
<span>                   K <span class="op">=</span> <span class="va">K</span>,</span>
<span>                   returnX <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                   trace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">colon2_fit</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-plotsummarize-results">Step 3: Plot/summarize results<a class="anchor" aria-label="anchor" href="#step-3-plotsummarize-results"></a>
</h3>
<p>To summarize a single model (no CV), we can look at a plot of the
coefficient paths:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fb_fit</span><span class="op">)</span></span></code></pre></div>
<p>We can also examine the number of selected variables at a particular
index of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>λ</mi><annotation encoding="application/x-tex">\lambda</annotation></semantics></math>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fb_fit</span>, idx <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-4-cross-validation-tuning-parameter-selection">Step 4: Cross-validation (tuning parameter selection)<a class="anchor" aria-label="anchor" href="#step-4-cross-validation-tuning-parameter-selection"></a>
</h3>
<p>In most applications, we will want to fit a model using cross
validation in order to choose an appropriate value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>λ</mi><annotation encoding="application/x-tex">\lambda</annotation></semantics></math>,
the tuning parameter for our penalized model.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_fb_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_plmm.html">cv_plmm</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">plink_data</span>,</span>
<span>                     type <span class="op">=</span> <span class="st">'blup'</span>,</span>
<span>                     returnX <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                     nfolds <span class="op">=</span> <span class="fl">3</span>, <span class="co"># for sake of testing, I made this small. </span></span>
<span>                     <span class="co"># In practice, 3 folds is usually not enough for robust </span></span>
<span>                     <span class="co"># cross validation - hence, the default is nfolds = 5</span></span>
<span>                     returnBiasDetails <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     trace <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     save_rds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">plink_data</span>,</span>
<span>                                          <span class="st">"cv"</span><span class="op">)</span>, <span class="co"># save_results to save folder as data </span></span>
<span>                     save_fold_res <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># saves loss and predictions in each fold</span></span>
<span>                     compact_save <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># saves results in separate files</span></span>
<span>                     seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span></span></code></pre></div>
<p>Fitting an equivalent model using the <code>penncath_lite</code> data
that uses RAM could look like this:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_plmm.html">cv_plmm</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">plink_data</span>,</span>
<span>                  type <span class="op">=</span> <span class="st">'blup'</span>,</span>
<span>                  nfolds <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                  returnBiasDetails <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                  trace <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                  seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">cv_fit</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cv_fit</span><span class="op">)</span></span>
<span><span class="fu">tinytest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tinytest/man/expect_equal.html" class="external-link">expect_equivalent</a></span><span class="op">(</span><span class="va">cv_fb_fit</span><span class="op">$</span><span class="va">cve</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">cve</span>, tolerance <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
<p>To summarize and plot a CV fit, we can look at a plot of cross
validation error:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cv_fb_fit</span><span class="op">)</span></span></code></pre></div>
<p>To summarize and visualize the model at the chosen
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>λ</mi><annotation encoding="application/x-tex">\lambda</annotation></semantics></math>
parameter value, we can do this:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">cv_fb_fit</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="comparing-candidate-models">Comparing candidate models<a class="anchor" aria-label="anchor" href="#comparing-candidate-models"></a>
</h3>
<p>The default penalty in <code>plmmr</code> is the lasso. Another
option would be the minimax-concave penalty (MCP)[^2]. Suppose we want
to compare our lasso-penalized model results with a MCP-penalized model.
We can fit a lasso model as shown:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fb_mcp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plmm.html">plmm</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">plink_data</span>,</span>
<span>                 penalty <span class="op">=</span> <span class="st">"MCP"</span>,</span>
<span>                 returnX <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                 trace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fb_mcp</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fb_mcp</span>, idx <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="to-add-predictors-that-are-not-genomic">To add predictors that are not genomic<a class="anchor" aria-label="anchor" href="#to-add-predictors-that-are-not-genomic"></a>
</h3>
<p>In many biological applications, we want to include some
features/covariates/predictors in addition to the genomic information,
like clinical or demographic information. Let’s suppose that in the
<code>penncath</code> data analysis, we want to include ‘sex’ and ‘age’
as unpenalized covariates. We can do this by supplying an additional
argument to <code><a href="../reference/process_plink.html">process_plink()</a></code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a new temporary directory, to avoid over-writing saved results</span></span>
<span><span class="va">temp_dir2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">LETTERS</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/unzip_example_data.html">unzip_example_data</a></span><span class="op">(</span>outdir <span class="op">=</span> <span class="va">temp_dir2</span><span class="op">)</span> <span class="co"># change this line if you're working on Windows</span></span>
<span></span>
<span><span class="va">pen_clinic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="../reference/find_example_data.html">find_example_data</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"/penncath_clinical.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">extdata</span> <span class="op">&lt;-</span> <span class="va">pen_clinic</span><span class="op">[</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">extdata</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">pen_clinic</span><span class="op">$</span><span class="va">FamID</span> <span class="co"># This is important! </span></span>
<span></span>
<span><span class="co"># create a new temporary directory</span></span>
<span><span class="va">new_plink_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/process_plink.html">process_plink</a></span><span class="op">(</span>data_dir <span class="op">=</span> <span class="va">temp_dir2</span>,</span>
<span>              <span class="co"># again, adjust this to wherever you've got the unzipped PLINK data</span></span>
<span>              rds_dir <span class="op">=</span> <span class="va">temp_dir2</span>, <span class="co"># using a temporary directory</span></span>
<span>              prefix <span class="op">=</span> <span class="st">"penncath_lite"</span>,</span>
<span>              id_var <span class="op">=</span> <span class="st">"FID"</span>, <span class="co"># this is KEY!</span></span>
<span>              outfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">temp_dir2</span>,<span class="st">"process_penncath_addvar"</span><span class="op">)</span>,</span>
<span>              impute_method <span class="op">=</span> <span class="st">"mode"</span>,</span>
<span>              add_predictor_ext <span class="op">=</span> <span class="va">extdata</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># check this out: </span></span>
<span><span class="va">pen2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">new_plink_data</span><span class="op">)</span></span>
<span><span class="va">pen2</span><span class="op">$</span><span class="va">std_X_colnames</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># std_X includes our non-genomic covariates </span></span>
<span><span class="va">pen2</span><span class="op">$</span><span class="va">std_X</span> <span class="op">&lt;-</span> <span class="fu">bigmemory</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bigmemory/man/attach.big.matrix.html" class="external-link">attach.big.matrix</a></span><span class="op">(</span><span class="va">pen2</span><span class="op">$</span><span class="va">std_X</span><span class="op">)</span></span></code></pre></div>
<p>We usually want these kinds of variables to always be in the model
(i.e., they are not penalized). To make sure ‘sex’ and ‘age’ are always
included in the chosen model, let’s set <code>penalty_factor</code> to
have 0 values corresponding to these predictors.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_plus_newvars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plmm.html">plmm</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">new_plink_data</span>,</span>
<span>                         penalty_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">pen2</span><span class="op">$</span><span class="va">std_X</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                         K <span class="op">=</span> <span class="va">fb_fit</span><span class="op">$</span><span class="va">K</span>, </span>
<span>                         returnX <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                         trace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We can check out how these additional covariates impact model
fit:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit_plus_newvars</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fb_fit</span>, idx <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_plus_newvars</span>, idx <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># at highest penalty value, sex and age are still in the model</span></span>
<span></span>
<span><span class="co"># look at the estimated coefficients </span></span>
<span><span class="va">fb_fit</span><span class="op">$</span><span class="va">beta_vals</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">fit_plus_newvars</span><span class="op">$</span><span class="va">beta_vals</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Tabitha K. Peter, Anna C. Reisetter, Patrick J. Breheny, Yujing Lu.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
